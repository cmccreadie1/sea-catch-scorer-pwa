<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sea Catch Scorer</title>
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0e2a47; 
            --accent-color: #00b894; 
            --text-dark: #2d3436;
            --bg-gradient-start: #0e2a47;
            --bg-gradient-end: #1c4b75;
            --card-bg: #eef6fc; 
            --input-bg: #f8fbfe; 
            --border-color: #dbe7f1;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-dark);
            overscroll-behavior-y: contain;
            padding-bottom: 60px;
            min-height: 100vh;
            background-attachment: fixed;
        }

        h1, h2, h3, h4, h5, .btn { font-family: 'Poppins', sans-serif; }

        .splash-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .splash-screen img {
            max-width: 180px;
            height: auto;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            animation: pulse 3s infinite ease-in-out;
        }

        .version-tag {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-bottom: 30px;
            color: #a4b0be;
        }

        .app-page {
            display: none; 
            max-width: 600px;
            margin: 20px auto;
            background: var(--card-bg);
            padding: 25px;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 40px;
        }

        .form-control, .form-select {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 12px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--primary-color);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.15);
            background-color: #ffffff;
        }
        
        .btn {
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-color); box-shadow: 0 4px 10px rgba(14, 42, 71, 0.3); }
        .btn-success { background-color: var(--accent-color); box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3); }
        .btn-secondary { background-color: #cfd8dc; color: #37474f; }
        .btn-danger { background-color: #ff7675; color: white; }
        .btn-whatsapp { background-color: #25D366; color: white; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); }

        .table { margin-top: 10px; border-collapse: separate; border-spacing: 0 8px; }
        .table thead th { border: none; color: #78909c; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;}
        .table tbody tr { background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .table tbody tr td { border: none; padding: 15px; vertical-align: middle; }
        .table tbody td:first-child { border-radius: 10px 0 0 10px; }
        .table tbody td:last-child { border-radius: 0 10px 10px 0; }

        #savedScorecardsList .card {
            border: none;
            background: var(--card-bg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border-radius: 16px;
            margin-bottom: 12px;
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .app-header { text-align: center; margin-bottom: 20px; }
        .app-header h2 { font-weight: 700; color: var(--primary-color); }

        .score-hero-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .score-hero-val {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1;
        }
        
        .score-hero-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #b0bec5;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #ffffff;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-card small {
            display: block;
            color: #90a4ae;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-card strong {
            font-size: 1.2rem;
            color: var(--text-dark);
        }

        .equation-box {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .eq-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .eq-row:last-child {
            border-bottom: none;
            padding-top: 12px;
            margin-top: 5px;
            border-top: 2px solid var(--border-color);
        }
        .eq-label { font-size: 0.85rem; color: #607d8b; }
        .eq-math { font-family: 'Inter', monospace; font-weight: 600; color: var(--text-dark); }
        .eq-total { font-size: 1.5rem; font-weight: 800; color: var(--primary-color); }

        .modal-content {
            border-radius: 24px;
            border: none;
            background-color: #f0f7fd;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-header { border-bottom: 1px solid #dae3eb; }
        .modal-body { background-color: #f0f7fd; }
        
        .inner-card {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .angler-name-display {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
            line-height: 1.2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="splashScreen" class="splash-screen">
            <img src="https://i.postimg.cc/pLFtxQWs/seacatchscorecard.jpg" alt="Sea Catch Scorer Logo">
            <h1 class="mb-2">Sea Catch Scorer</h1>
            <p class="version-tag text-white-50">Version 31.0 (Final Install)</p>
            <div class="d-grid gap-3 col-10 col-md-6">
                <button id="btnStartFishing" class="btn btn-light btn-lg text-primary fw-bold shadow-lg">
                    <i class="bi bi-play-circle-fill me-2"></i> Start Fishing
                </button>
                <button id="btnSavedLogs" class="btn btn-outline-light btn-lg border-2 fw-bold" data-bs-toggle="modal" data-bs-target="#savedScorecardsModal">
                    <i class="bi bi-journal-text me-2"></i> Saved Scorecards
                </button>
                <button id="btnInstall" class="btn btn-outline-info btn-sm rounded-pill mt-3" style="display:none;">
                    <i class="bi bi-download me-1"></i> Install App
                </button>
            </div>
        </div>

        <div class="modal fade" id="savedScorecardsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold text-primary">Fishing Logbook</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="savedScorecardsList"></div>
                        
                        <div id="fullScorecardView" class="full-scorecard" style="display:none;">
                            <div class="text-center mb-4">
                                <div id="saved_angler" class="angler-name-display"></div>
                                <div class="text-muted small">
                                    <span id="saved_venue"></span> â€¢ <span id="saved_date"></span>
                                </div>
                            </div>

                            <div class="score-hero-container">
                                <div class="score-hero-label">Total Score</div>
                                <div id="saved_total_points" class="score-hero-val">0</div>
                            </div>

                            <div class="equation-box">
                                <div class="eq-row">
                                    <span class="eq-label">Fish Points (Qty Ã— 5)</span>
                                    <span class="eq-math" id="saved_eq_fish">0</span>
                                </div>
                                <div class="eq-row">
                                    <span class="eq-label">Length Points</span>
                                    <span class="eq-math" id="saved_eq_len">0</span>
                                </div>
                                <div class="eq-row">
                                    <span class="eq-label fw-bold text-primary">TOTAL SCORE</span>
                                    <span class="eq-total" id="saved_eq_total">0</span>
                                </div>
                            </div>

                            <div class="stat-grid">
                                <div class="stat-card border-success border-opacity-50" style="grid-column: span 2;">
                                    <small class="text-success">Biggest Fish</small>
                                    <strong id="saved_biggest_fish" class="text-success">-</strong>
                                </div>
                                <div class="stat-card">
                                    <small>Total Fish</small>
                                    <strong id="saved_fish_count">0</strong>
                                </div>
                                <div class="stat-card">
                                    <small>Total Length</small>
                                    <strong id="saved_total_len">0 cm</strong>
                                </div>
                                <div class="stat-card">
                                    <small>Zone</small>
                                    <strong id="saved_zone">-</strong>
                                </div>
                                <div class="stat-card">
                                    <small>Peg</small>
                                    <strong id="saved_peg">-</strong>
                                </div>
                            </div>

                            <h6 class="text-muted text-uppercase fs-7 fw-bold ps-2">Catch Log</h6>
                            <table class="table table-borderless">
                                <thead>
                                    <tr><th>Species</th><th class="text-end">Length</th></tr>
                                </thead>
                                <tbody id="saved_fish_log"></tbody>
                            </table>
                            
                            <div class="d-grid gap-2 mt-4 pt-3 border-top">
                                <button class="btn btn-whatsapp" onclick="window.sendToWhatsApp('saved')">
                                    <i class="bi bi-whatsapp me-2"></i> Share to WhatsApp
                                </button>
                                <button class="btn btn-outline-secondary" onclick="window.copyToClipboard('saved')">
                                    <i class="bi bi-clipboard me-2"></i> Copy Text
                                </button>
                                <button class="btn btn-secondary mt-2" onclick="window.backToScorecardList()">
                                    <i class="bi bi-arrow-left me-2"></i> Back
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="anglerRegistration" class="app-page">
            <div class="app-header">
                <h2>New Session</h2>
                <p>Enter details to start fishing</p>
            </div>
            <div class="mb-3">
                <label for="anglerName" class="form-label">Angler Name</label>
                <input type="text" id="anglerName" class="form-control" placeholder="e.g. Christopher">
            </div>
            <div class="row">
                <div class="col-6 mb-3">
                    <label for="competitionDate" class="form-label">Date</label>
                    <input type="date" id="competitionDate" class="form-control">
                </div>
                <div class="col-6 mb-3">
                    <label for="venueInput" class="form-label">Venue</label>
                    <input type="text" id="venueInput" class="form-control" placeholder="Location">
                </div>
            </div>
            <div class="inner-card mb-4">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="isCompetition">
                    <label class="form-check-label fw-bold text-dark" for="isCompetition">Competition Mode</label>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <select id="zoneInput" class="form-select" disabled>
                            <option value="" selected>Zone</option>
                            <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <select id="pegInput" class="form-select" disabled>
                            <option value="" selected>Peg</option>
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-secondary flex-grow-1" onclick="window.resetApp()">Cancel</button>
                <button class="btn btn-primary flex-grow-1" onclick="window.registerAngler()">Let's Fish <i class="bi bi-arrow-right ms-2"></i></button>
            </div>
        </div>

        <div id="anglerFishingPage" class="app-page">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="m-0 fw-bold text-primary">Live Catch</h4>
                <button class="btn btn-sm btn-outline-danger rounded-pill px-3" style="font-size: 0.75rem;" onclick="window.confirmQuit()">Quit / Reset</button>
            </div>
            <div class="inner-card mb-4 border border-primary border-opacity-25">
                <div class="mb-3">
                    <label class="form-label text-primary">Species</label>
                    <select id="speciesInput" class="form-select" onchange="window.toggleCustomSpeciesInput()">
                        <option value="" selected>Select Fish...</option>
                        <option value="Other">Other (specify)</option>
                    </select>
                    <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter Species Name" style="display:none;">
                </div>
                <div class="row g-2">
                    <div class="col-8">
                        <label class="form-label text-primary">Length (cm)</label>
                        <input type="number" id="lengthInput" class="form-control" placeholder="0">
                    </div>
                    <div class="col-4 d-flex align-items-end">
                        <button class="btn btn-success w-100" onclick="window.addFish()">
                            <i class="bi bi-plus-lg"></i> Add
                        </button>
                    </div>
                </div>
            </div>
            <h5 class="text-muted fs-6 text-uppercase fw-bold letter-spacing-1">Current Haul</h5>
            <div class="table-responsive">
                <table class="table table-borderless"><tbody id="fishLog"></tbody></table>
            </div>
            <div class="mt-4 pt-3 border-top">
                <button class="btn btn-danger w-100 py-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#endSessionModal">Finish Session</button>
            </div>
        </div>

        <div id="tallyVerificationPage" class="app-page">
            <div class="text-center mb-4">
                <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2 shadow" style="width: 60px; height: 60px;">
                    <i class="bi bi-check-lg fs-2"></i>
                </div>
                <h2 class="fw-bold text-primary">Session Complete</h2>
            </div>

            <div class="score-hero-container">
                <div class="score-hero-label">Total Points</div>
                <div id="session_total_points" class="score-hero-val">0</div>
            </div>

            <div class="equation-box">
                <div class="eq-row">
                    <span class="eq-label">Fish Points (Qty Ã— 5)</span>
                    <span class="eq-math" id="session_eq_fish">0</span>
                </div>
                <div class="eq-row">
                    <span class="eq-label">Length Points</span>
                    <span class="eq-math" id="session_eq_len">0</span>
                </div>
                <div class="eq-row">
                    <span class="eq-label fw-bold text-primary">TOTAL SCORE</span>
                    <span class="eq-total" id="session_eq_total">0</span>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-card border-success border-opacity-50" style="grid-column: span 2;">
                    <small class="text-success">Biggest Fish</small>
                    <strong id="session_biggest_fish" class="text-success">-</strong>
                </div>
                <div class="stat-card">
                    <small>Total Fish</small>
                    <strong id="session_total_fish">0</strong>
                </div>
                <div class="stat-card">
                    <small>Total Length</small>
                    <strong id="session_total_len">0 cm</strong>
                </div>
            </div>

            <h6 class="text-muted fs-7 mb-3 text-uppercase fw-bold">Catch Breakdown</h6>
            <table class="table table-borderless">
                <thead>
                    <tr><th>Species</th><th class="text-center">Qty</th><th class="text-end">Length</th></tr>
                </thead>
                <tbody id="live_tally_table"></tbody>
            </table>

            <div class="d-grid gap-3 mt-4">
                <button class="btn btn-primary btn-lg shadow" onclick="window.saveAndEndSession()">
                    <i class="bi bi-save me-2"></i> Save & Exit
                </button>
                <button class="btn btn-whatsapp" onclick="window.sendToWhatsApp('live')">
                    <i class="bi bi-whatsapp me-2"></i> Share to WhatsApp
                </button>
                <button class="btn btn-outline-secondary" onclick="window.copyToClipboard('live')">
                    <i class="bi bi-clipboard me-2"></i> Copy Text
                </button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="endSessionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-body text-center p-4">
                    <h4 class="mb-2 fw-bold">Finish Session?</h4>
                    <p class="text-muted mb-4">This will finalize your log.</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-danger" onclick="window.endSession()" data-bs-dismiss="modal">Yes, Finish It</button>
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Keep Fishing</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const StorageHelper = {
            memoryStore: {},
            save: function(key, value) {
                this.memoryStore[key] = value;
                try { localStorage.setItem(key, value); } catch(e) {}
            },
            remove: function(key) {
                delete this.memoryStore[key];
                try { localStorage.removeItem(key); } catch(e) {}
            },
            getAll: function() {
                const result = { ...this.memoryStore };
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if(k.startsWith('scorecard_') || k === 'active_session') {
                            result[k] = localStorage.getItem(k);
                        }
                    }
                } catch(e) {}
                return result;
            },
            get: function(key) {
                try {
                    const diskVal = localStorage.getItem(key);
                    if(diskVal) return diskVal;
                } catch(e) {}
                return this.memoryStore[key];
            }
        };

        const PageManager = {
            show: function(pageId) {
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('anglerRegistration').style.display = 'none';
                document.getElementById('anglerFishingPage').style.display = 'none';
                document.getElementById('tallyVerificationPage').style.display = 'none';
                
                if(pageId === 'splashScreen') {
                    document.getElementById('splashScreen').style.display = 'flex';
                } else {
                    document.getElementById(pageId).style.display = 'block';
                }
                window.scrollTo(0,0);
            }
        };

        const samfFishCategories = {
            "Flatfish": ["Brill", "Dab", "Flounder", "Halibut", "Megrim", "Plaice", "Sole (Dover)", "Sole (Lemon)", "Sole (Thickback)", "Turbot"],
            "Round Fish": ["Bass", "Bream (Black)", "Bream (Gilthead)", "Bream (Red)", "Bream (Sea)", "Bull Huss", "Coalfish", "Cod", "Conger Eel", "Dogfish (Blackmouth)", "Dogfish (LSD)", "Gurnard (Red)", "Gurnard (Tub)", "Haddock", "Hake", "John Dory", "Ling", "Mackerel", "Monkfish", "Mullet (Grey)", "Mullet (Red)", "Pollack", "Poor Cod", "Pouting", "Saithe", "Salmon", "Shark (Blue)", "Shark (Porbeagle)", "Shark (Thresher)", "Smoothhound", "Sprat", "Tope", "Triggerfish", "Whiting"],
            "Rays and Skates": ["Ray (Blonde)", "Ray (Small-eyed)", "Ray (Spotted)", "Ray (Starry)", "Ray (Thornback)", "Skate"],
            "Wrasse": ["Wrasse (Ballan)", "Wrasse (Cuckoo)"]
        };

        let fishData = [];
        let currentAngler = null, currentDate = null, currentVenue = null, currentZone = null, currentPeg = null, currentViewingLog = null;

        window.formatDate = function(dateString) {
            try {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            } catch (e) { return 'N/A'; }
        };

        window.calculatePoints = function(totalFish, totalLength) {
            return Math.round((totalFish * 5) + totalLength);
        };

        window.saveActiveSession = function() {
            try {
                const activeData = {
                    angler: currentAngler, date: currentDate, venue: currentVenue,
                    zone: currentZone, peg: currentPeg, fishData: fishData
                };
                StorageHelper.save('active_session', JSON.stringify(activeData));
            } catch(e) {}
        };

        window.restoreActiveSession = function() {
            const saved = StorageHelper.get('active_session');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if(data.angler && data.date) {
                        currentAngler = data.angler;
                        currentDate = data.date;
                        currentVenue = data.venue;
                        currentZone = data.zone;
                        currentPeg = data.peg;
                        fishData = data.fishData || [];
                        PageManager.show('anglerFishingPage');
                        window.updateFishLog();
                    }
                } catch(e) {}
            }
        };

        window.clearActiveSession = function() {
            StorageHelper.remove('active_session');
        };

        window.confirmQuit = function() {
            if(confirm("Abandon this session?")) window.resetApp();
        };

        window.startFishing = function() {
            window.clearActiveSession();
            fishData = []; currentAngler = null;
            document.getElementById('anglerName').value = '';
            document.getElementById('competitionDate').value = '';
            document.getElementById('venueInput').value = '';
            PageManager.show('anglerRegistration');
        };
        
        window.goBackToRegistration = function() {
            PageManager.show('anglerRegistration');
        };

        window.endSession = function() {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(bd => bd.remove());
            document.body.classList.remove('modal-open');
            document.body.style = '';

            PageManager.show('tallyVerificationPage');
            
            const tallyTable = document.getElementById('live_tally_table');
            tallyTable.innerHTML = '';
            
            let totalFish = 0, totalLength = 0, maxLen = 0, biggestFishName = "None";
            const summary = {};

            fishData.forEach(fish => {
                const len = parseFloat(fish.length); 
                totalFish++;
                totalLength += len;
                if(len > maxLen) { maxLen = len; biggestFishName = `${fish.species} (${len}cm)`; }

                if(!summary[fish.species]) summary[fish.species] = { count: 0, totalLength: 0, lengths: [] };
                summary[fish.species].count++;
                summary[fish.species].totalLength += len;
                summary[fish.species].lengths.push(len);
            });

            const fishPts = totalFish * 5;
            const lenPts = Math.round(totalLength);
            const totalPts = fishPts + lenPts;

            document.getElementById('session_total_points').textContent = totalPts;
            document.getElementById('session_eq_fish').textContent = fishPts;
            document.getElementById('session_eq_len').textContent = lenPts;
            document.getElementById('session_eq_total').textContent = totalPts;
            
            document.getElementById('session_total_fish').textContent = totalFish;
            document.getElementById('session_total_len').textContent = parseFloat(totalLength.toFixed(2)) + ' cm';
            document.getElementById('session_biggest_fish').textContent = biggestFishName;

            for (const species in summary) {
                const row = document.createElement('tr');
                let lenDisplay = parseFloat(summary[species].totalLength.toFixed(2)) + ' cm';
                if(summary[species].count > 1) {
                    lenDisplay += `<div class="small text-muted" style="font-size:0.7rem;">(${summary[species].lengths.join(', ')})</div>`;
                }
                row.innerHTML = `<td class="fw-bold">${species}</td><td class="text-center"><span class="badge bg-secondary rounded-pill">${summary[species].count}</span></td><td class="text-end">${lenDisplay}</td>`;
                tallyTable.appendChild(row);
            }
        };

        window.resetApp = function() {
            fishData = []; currentAngler = null; currentDate = null; currentVenue = null; currentZone = null; currentPeg = null;
            window.clearActiveSession();
            document.getElementById('anglerName').value = '';
            document.getElementById('competitionDate').value = '';
            document.getElementById('venueInput').value = '';
            PageManager.show('splashScreen');
        };

        window.registerAngler = function() {
            const anglerName = document.getElementById('anglerName').value.trim();
            const competitionDate = document.getElementById('competitionDate').value;
            const venueInput = document.getElementById('venueInput').value.trim();
            const isCompetition = document.getElementById('isCompetition').checked;
            
            if (!anglerName || !competitionDate || !venueInput) return alert("Please fill in Name, Date and Venue.");
            
            if (isCompetition) {
                currentZone = document.getElementById('zoneInput').value;
                currentPeg = document.getElementById('pegInput').value;
                if (!currentZone || !currentPeg) return alert("Please select Zone and Peg.");
            } else { currentZone = null; currentPeg = null; }

            fishData = [];
            window.updateFishLog(); 
            currentAngler = anglerName; currentDate = competitionDate; currentVenue = venueInput;
            window.saveActiveSession();
            window.populateSpeciesDropdown();
            PageManager.show('anglerFishingPage');
        };

        window.populateSpeciesDropdown = function() {
            const speciesInput = document.getElementById('speciesInput');
            speciesInput.innerHTML = '<option value="" selected>Select Fish...</option><option value="Other">Other (specify)</option>';
            for (const category in samfFishCategories) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                samfFishCategories[category].forEach(species => {
                    const option = document.createElement('option');
                    option.value = species; option.textContent = species;
                    optgroup.appendChild(option);
                });
                speciesInput.appendChild(optgroup);
            }
        };

        window.addFish = function() {
            const speciesInput = document.getElementById('speciesInput');
            const customSpeciesInput = document.getElementById('customSpeciesInput');
            const lengthInput = document.getElementById('lengthInput');
            let species = speciesInput.value;
            let length = parseFloat(lengthInput.value);

            if (species === 'Other') species = customSpeciesInput.value.trim();
            if (!species || species === '') return alert("Select a species");
            if (isNaN(length) || length <= 0) return alert("Enter valid length");

            fishData.push({ species, length });
            window.saveActiveSession(); 
            window.updateFishLog();
            
            speciesInput.value = ''; customSpeciesInput.value = ''; lengthInput.value = '';
            window.toggleCustomSpeciesInput();
        };

        window.updateFishLog = function() {
            const fishLog = document.getElementById('fishLog');
            fishLog.innerHTML = '';
            fishData.forEach((fish, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="fw-bold text-dark">${fish.species}</td><td class="text-end text-muted">${fish.length} cm</td><td class="text-end" style="width:50px;"><button class="btn btn-sm btn-outline-danger border-0" onclick="window.deleteFish(${index})"><i class="bi bi-trash"></i></button></td>`;
                fishLog.appendChild(row);
            });
        };

        window.deleteFish = function(index) {
            if (confirm("Remove catch?")) { 
                fishData.splice(index, 1); 
                window.saveActiveSession(); 
                window.updateFishLog(); 
            }
        };

        window.saveAndEndSession = function() {
            if (fishData.length === 0 && !confirm("No fish caught. Save empty session?")) return;
            const totalFish = fishData.length;
            const totalLength = fishData.reduce((sum, f) => sum + parseFloat(f.length || 0), 0);
            
            const sessionData = {
                angler: currentAngler, date: currentDate, venue: currentVenue,
                zone: currentZone, peg: currentPeg, fishData: fishData,
                totalPoints: window.calculatePoints(totalFish, totalLength),
                totalFish: totalFish, totalLength: totalLength
            };
            
            StorageHelper.save(`scorecard_${Date.now()}`, JSON.stringify(sessionData));
            alert("Scorecard Saved Successfully!");
            window.resetApp(); 
        };

        window.loadSavedScorecards = function() {
            const list = document.getElementById('savedScorecardsList');
            list.innerHTML = '';
            const allData = StorageHelper.getAll();
            const keys = Object.keys(allData).sort().reverse();

            for (const key of keys) {
                if (key.startsWith('scorecard_')) {
                    try {
                        const data = JSON.parse(allData[key]);
                        if(!data.fishData) data.fishData = [];
                        const len = data.fishData.reduce((s,f) => s + (parseFloat(f.length)||0), 0);
                        const pts = window.calculatePoints(data.fishData.length, len);

                        const card = document.createElement('div');
                        card.className = 'card';
                        card.onclick = () => window.viewFullScorecard(key);
                        card.innerHTML = `
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold text-dark mb-1">${data.venue}</div>
                                        <div class="small text-muted">
                                            <i class="bi bi-calendar3 me-1"></i> ${window.formatDate(data.date)} 
                                            <span class="ms-2 badge bg-primary bg-opacity-10 text-primary">${pts} pts</span>
                                        </div>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </div>
                        `;
                        list.appendChild(card); 
                    } catch(e) {}
                }
            }
            if(list.innerHTML === '') list.innerHTML = `<div class="text-center py-4 text-muted">No saved logs yet.</div>`;
        };

        window.viewFullScorecard = function(key) {
            try {
                const jsonStr = StorageHelper.get(key);
                const data = JSON.parse(jsonStr);
                currentViewingLog = data; 

                if (!data.fishData) data.fishData = [];
                let totalFish = 0, totalLength = 0, maxLen = 0, biggestFishName = "None";
                const summary = {};

                data.fishData.forEach(fish => {
                    const len = parseFloat(fish.length) || 0;
                    totalFish++;
                    totalLength += len;
                    if(len > maxLen) { maxLen = len; biggestFishName = `${fish.species} (${len}cm)`; }

                    if(!summary[fish.species]) summary[fish.species] = { count: 0, totalLength: 0, lengths: [] };
                    summary[fish.species].count++;
                    summary[fish.species].totalLength += len;
                    summary[fish.species].lengths.push(len);
                });

                const fishPts = totalFish * 5;
                const lenPts = Math.round(totalLength);
                const totalPts = fishPts + lenPts;

                document.getElementById('saved_venue').textContent = data.venue;
                document.getElementById('saved_date').textContent = window.formatDate(data.date);
                document.getElementById('saved_angler').textContent = data.angler;
                
                document.getElementById('saved_total_points').textContent = totalPts;
                document.getElementById('saved_eq_fish').textContent = fishPts;
                document.getElementById('saved_eq_len').textContent = lenPts;
                document.getElementById('saved_eq_total').textContent = totalPts;

                document.getElementById('saved_fish_count').textContent = totalFish;
                document.getElementById('saved_total_len').textContent = parseFloat(totalLength.toFixed(2)) + ' cm';
                document.getElementById('saved_zone').textContent = data.zone || '-';
                document.getElementById('saved_peg').textContent = data.peg || '-';
                document.getElementById('saved_biggest_fish').textContent = biggestFishName;

                const log = document.getElementById('saved_fish_log');
                log.innerHTML = '';
                for (const species in summary) {
                    const row = document.createElement('tr');
                    let lenDisplay = parseFloat(summary[species].totalLength.toFixed(2)) + ' cm';
                    if(summary[species].count > 1) {
                        lenDisplay += `<div class="small text-muted" style="font-size:0.7rem; margin-top:2px;">(${summary[species].lengths.join(', ')})</div>`;
                    }
                    row.innerHTML = `<td class="fw-bold">${species}</td><td class="text-center"><span class="badge bg-secondary rounded-pill">${summary[species].count}</span></td><td class="text-end">${lenDisplay}</td>`;
                    log.appendChild(row);
                }

                document.getElementById('savedScorecardsList').style.display = 'none';
                document.getElementById('fullScorecardView').style.display = 'block';
            } catch (e) { console.error(e); alert("Could not load details."); }
        };

        window.toggleCustomSpeciesInput = function() {
            const speciesInput = document.getElementById('speciesInput');
            const customInput = document.getElementById('customSpeciesInput');
            customInput.style.display = speciesInput.value === 'Other' ? 'block' : 'none';
        };

        window.toggleCompetitionFields = function() {
            const isComp = document.getElementById('isCompetition').checked;
            document.getElementById('zoneInput').disabled = !isComp;
            document.getElementById('pegInput').disabled = !isComp;
        };

        window.getShareData = function(context) {
            let data = {};
            if (context === 'live') {
                data = {
                    angler: currentAngler,
                    venue: currentVenue,
                    peg: currentPeg || '-',
                    totalPoints: document.getElementById('session_total_points').textContent,
                    totalFish: document.getElementById('session_total_fish').textContent,
                    totalLen: document.getElementById('session_total_len').textContent,
                    bestFish: document.getElementById('session_biggest_fish').textContent
                };
            } else {
                if (!currentViewingLog) return null;
                const log = currentViewingLog;
                data = {
                    angler: log.angler,
                    venue: log.venue,
                    peg: log.peg || '-',
                    totalPoints: document.getElementById('saved_total_points').textContent,
                    totalFish: document.getElementById('saved_fish_count').textContent,
                    totalLen: document.getElementById('saved_total_len').textContent,
                    bestFish: document.getElementById('saved_biggest_fish').textContent
                };
            }
            return `*MATCH RESULT* ðŸŸ\n\n*Angler:* ${data.angler}\n*Venue:* ${data.venue}\n*Peg:* ${data.peg}\n\nðŸ† *Score: ${data.totalPoints} pts*\n\n*Stats:*\n- Fish: ${data.totalFish}\n- Length: ${data.totalLen}\n- Best: ${data.bestFish}`;
        };

        window.sendToWhatsApp = function(context) {
            const text = window.getShareData(context);
            if (!text) return;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const encodedText = encodeURIComponent(text);
            if (isMobile) {
                window.location.href = `whatsapp://send?text=${encodedText}`;
            } else {
                window.open(`https://wa.me/?text=${encodedText}`, '_blank');
            }
        };

        window.copyToClipboard = function(context) {
            const text = window.getShareData(context);
            if(!text) return;
            if(navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert("Result Copied! Open WhatsApp and Paste."));
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; 
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("Result Copied! Open WhatsApp and Paste.");
                } catch (err) {
                    alert("Could not copy. Please screenshot.");
                }
                document.body.removeChild(textArea);
            }
        };
        
        // PWA Install Prompt Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('btnInstall');
            if(installBtn) {
                installBtn.style.display = 'block';
                installBtn.addEventListener('click', () => {
                    installBtn.style.display = 'none';
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        deferredPrompt = null;
                    });
                });
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnStartFishing').addEventListener('click', window.startFishing);
            document.getElementById('btnSavedLogs').addEventListener('click', window.loadSavedScorecards);
            document.getElementById('isCompetition').addEventListener('change', window.toggleCompetitionFields);

            window.restoreActiveSession();
            
            const savedModal = document.getElementById('savedScorecardsModal');
            savedModal.addEventListener('hidden.bs.modal', window.backToScorecardList);
            window.toggleCompetitionFields();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker: Registered'))
                    .catch(err => console.log('Service Worker: Error', err));
            });
        }
    </script>
</body>
</html>
