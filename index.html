<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Sea Catch Scorer</title>
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #0e2a47; 
            --accent-color: #10b981; 
            --text-dark: #2d3436;
            --bg-gradient: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            --card-bg: #ffffff;
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-dark);
            padding-bottom: 60px;
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, .btn { font-family: 'Poppins', sans-serif; }

        /* SPLASH */
        .splash-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white;
            text-align: center; padding: 20px;
        }
        .splash-screen img { max-width: 140px; border-radius: 24px; margin-bottom: 25px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); }
        .version-tag { font-size: 0.75rem; color: #94a3b8; margin-bottom: 30px; letter-spacing: 1px; text-transform: uppercase; }

        /* APP PAGES */
        .app-page { display: none; max-width: 600px; margin: 20px auto; padding: 0 15px 30px 15px; }
        
        .inner-card {
            background: var(--card-bg); border-radius: 20px; padding: 20px;
            box-shadow: var(--shadow-md); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.5);
        }

        /* CONTROLS */
        .form-label { font-weight: 700; color: var(--primary-color); font-size: 0.8rem; text-transform: uppercase; margin-bottom: 8px; }
        .form-control, .form-select {
            border-radius: 12px; padding: 12px 16px; font-weight: 500;
            background-color: #f8fafc; border: 1px solid #cbd5e1;
        }
        .btn { border-radius: 50px; padding: 12px 24px; font-weight: 600; text-transform: uppercase; border: none; }
        .btn-primary { background: var(--primary-color); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-whatsapp { background-color: #25D366; color: white; }

        /* HEADER */
        .app-header { text-align: center; margin-bottom: 25px; margin-top: 10px; }
        .app-header h2 { font-weight: 800; color: var(--primary-color); }

        /* SCORE HERO */
        .score-hero-container {
            background: white; border-radius: 20px; padding: 20px; text-align: center;
            box-shadow: var(--shadow-md); margin-bottom: 20px; border: 1px solid #e2e8f0;
        }
        .score-hero-val {
            font-size: 3.5rem; font-weight: 800; color: var(--primary-color); line-height: 1;
        }
        .score-hero-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; font-weight: 700; }

        /* STAT GRID */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #ffffff; padding: 10px 5px; border-radius: 14px; text-align: center; border: 1px solid #f1f5f9; }
        .stat-card small { display: block; color: #94a3b8; font-size: 0.65rem; text-transform: uppercase; font-weight: 700; }
        .stat-card strong { font-size: 1.1rem; color: var(--text-dark); font-weight: 700; }

        /* EQUATION & INFO */
        .equation-box { background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 14px; padding: 15px; margin-bottom: 20px; }
        .eq-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.9rem; color: #64748b; }
        .rule-info-box {
            background-color: #eff6ff; border-left: 4px solid #3b82f6; color: #1e40af;
            padding: 12px 15px; border-radius: 8px; font-size: 0.85rem; margin-top: 15px; display: none;
        }

        /* SPECIES HUNT VISUALIZER (3 PIPS) */
        .species-quota-card {
            background: white; border-radius: 16px; padding: 12px 15px; margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
        }
        .sq-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .sq-name { font-weight: 700; color: var(--primary-color); font-size: 1rem; }
        .sq-pips { display: flex; align-items: center; gap: 6px; }
        .pip {
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; font-weight: 700; background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0;
        }
        .pip.active { background: #10b981; color: white; border-color: #059669; }
        .pip.gold.active { background: #eab308; color: white; border-color: #ca8a04; }
        .pip-extra { font-size: 0.75rem; color: #64748b; margin-left: auto; font-weight: 500; }

        /* LISTS */
        .table-custom { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .table-custom td { background: white; padding: 12px; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
        .table-custom tr td:first-child { border-left: 1px solid #f1f5f9; border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        .table-custom tr td:last-child { border-right: 1px solid #f1f5f9; border-top-right-radius: 12px; border-bottom-right-radius: 12px; }

        /* SWITCH */
        .big-switch {
            display: flex; align-items: center; padding: 10px; background: #ffffff;
            border-radius: 12px; border: 2px solid #90a4ae; box-shadow: 0 3px 5px rgba(0,0,0,0.06);
        }
        .big-switch .form-check-input { width: 3.2em; height: 1.6em; margin-right: 12px; }
        .big-switch .form-check-label { font-size: 1rem; font-weight: 700; color: var(--primary-color); }
        
        .verification-box { display: none; background-color: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 12px; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="splashScreen" class="splash-screen">
        <img src="icon.png" alt="Logo">
        <h1 class="mb-1">Sea Catch Scorer</h1>
        <p class="version-tag">Version 85.0</p>
        <div class="d-grid gap-3 col-10 col-md-6">
            <button class="btn btn-light btn-lg text-primary fw-bold shadow-lg" onclick="window.startFishing()">Start Fishing</button>
            <button class="btn btn-outline-light btn-lg fw-bold" onclick="window.loadSavedScorecards()" data-bs-toggle="modal" data-bs-target="#savedModal">Saved Scorecards</button>
            <button id="btnInstall" class="btn btn-info btn-sm rounded-pill mt-2 text-white fw-bold" style="display:none;">Install App</button>
        </div>
    </div>

    <div id="anglerRegistration" class="app-page">
        <div class="app-header">
            <h2>New Session</h2>
            <p>Setup match details</p>
        </div>
        
        <div class="inner-card">
            <div class="mb-3">
                <label class="form-label">Angler Name</label>
                <input type="text" id="anglerName" class="form-control" placeholder="Your Name">
            </div>
            <div class="row g-2">
                <div class="col-6">
                    <label class="form-label">Date</label>
                    <input type="date" id="competitionDate" class="form-control">
                </div>
                <div class="col-6">
                    <label class="form-label">Venue</label>
                    <input type="text" id="venueInput" class="form-control" placeholder="Location">
                </div>
            </div>
        </div>
        
        <div class="inner-card">
            <div class="section-title"><i class="bi bi-calculator"></i> Scoring Rules</div>
            <select id="scoringMethod" class="form-select" onchange="window.checkRuleInfo()">
                <option value="" disabled selected>Select Scoring Method...</option>
                <option value="measure_points">Length + 10 Pts (Per Fish)</option>
                <option value="length_only">Total Length Only</option>
                <option value="species_hunt">Species Hunt (3=100pts)</option>
            </select>

            <div id="speciesHuntInfo" class="rule-info-box">
                <div class="fw-bold"><i class="bi bi-trophy me-2"></i>Target 3 Fish:</div>
                <ul class="small mb-0 mt-1 ps-3">
                    <li>1st: <strong>30</strong> | 2nd: <strong>30</strong></li>
                    <li>3rd: <strong>40</strong> (Full House 100)</li>
                    <li>4th+: <strong>1</strong> pt</li>
                </ul>
            </div>
            
            <div id="measurePointsInfo" class="rule-info-box">
                <div class="fw-bold"><i class="bi bi-ruler me-2"></i>Measure + 10:</div>
                <div class="small mt-1">Score = Total Cm + (Count x 10)</div>
            </div>
        </div>

        <div class="inner-card">
            <div class="form-check form-switch big-switch mb-3">
                <input class="form-check-input" type="checkbox" id="isCompetition" onchange="window.toggleCompetitionFields()">
                <label class="form-check-label" for="isCompetition">Competition Mode</label>
            </div>
            <div class="row g-2">
                <div class="col-6"><select id="zoneInput" class="form-select" disabled><option selected>Zone</option><option>A</option><option>B</option><option>C</option><option>D</option></select></div>
                <div class="col-6"><select id="pegInput" class="form-select" disabled><option selected>Peg</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
            </div>
        </div>

        <div class="d-flex gap-3 mt-4">
            <button class="btn btn-secondary flex-grow-1" onclick="window.resetApp()">Cancel</button>
            <button class="btn btn-primary flex-grow-1 shadow" onclick="window.registerAngler()">Let's Fish <i class="bi bi-arrow-right ms-2"></i></button>
        </div>
    </div>

    <div id="anglerFishingPage" class="app-page">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="m-0 fw-bold text-primary">Live Catch</h4>
            <button class="btn btn-sm btn-outline-danger rounded-pill px-3" onclick="window.confirmQuit()">Quit</button>
        </div>
        
        <div class="inner-card mb-4" style="background: #f8fafc;">
            <div class="mb-3">
                <label class="form-label text-primary">Species</label>
                <select id="speciesInput" class="form-select form-select-lg" onchange="window.toggleCustomSpeciesInput()">
                    <option value="" selected>Select Fish...</option>
                    </select>
                <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter Name" style="display:none;">
            </div>
            
            <div class="row g-2" id="lengthInputContainer">
                <div class="col-7">
                    <label class="form-label text-primary">Length (cm)</label>
                    <input type="number" id="lengthInput" class="form-control form-control-lg" placeholder="0">
                </div>
                <div class="col-5 d-flex align-items-end">
                    <button class="btn btn-success w-100 py-2 shadow-sm" onclick="window.addFish()">
                        <i class="bi bi-plus-lg"></i> Add
                    </button>
                </div>
            </div>
            
            <div id="speciesHuntAddBtn" style="display:none;" class="mt-3">
                <button class="btn btn-success w-100 py-3 shadow-sm" onclick="window.addFish()">
                    <i class="bi bi-check-circle-fill me-2"></i> RECORD CATCH
                </button>
            </div>
        </div>

        <h5 class="text-muted fs-6 text-uppercase fw-bold letter-spacing-1 ps-2">Haul History</h5>
        <div class="table-responsive">
            <table class="table-custom"><tbody id="fishLog"></tbody></table>
        </div>
        
        <div class="mt-4 pt-3">
            <button class="btn btn-danger w-100 py-3 shadow" onclick="window.endSession()">Finish Session</button>
        </div>
    </div>

    <div id="tallyVerificationPage" class="app-page">
        <div class="inner-card p-3 mb-3 text-center">
            <h2 class="text-primary fw-bold mb-0">Session Complete</h2>
            <div id="session_angler" class="fw-bold text-dark mt-1 fs-5"></div>
            <div class="text-muted small mt-1">
                <span id="session_date"></span> • <span id="session_venue"></span>
            </div>
            <div id="session_comp_details" style="display:none;" class="mt-2 badge bg-primary bg-opacity-10 text-primary">
                Zone: <span id="session_zone"></span> | Peg: <span id="session_peg"></span>
            </div>
        </div>

        <div class="score-hero-container">
            <div class="score-hero-label">Total Points</div>
            <div id="session_total_points" class="score-hero-val">0</div>
        </div>

        <div class="stat-grid">
            <div id="session_biggest_fish_card" class="stat-card border-success" style="grid-column: span 3; border-color: #86efac; background:#f0fdf4;">
                <small class="text-success">Biggest Fish</small>
                <strong id="session_biggest_fish" class="text-success">-</strong>
            </div>
            <div class="stat-card"><small>Fish</small><strong id="session_total_fish">0</strong></div>
            <div class="stat-card"><small>Species</small><strong id="session_species_count">0</strong></div>
            <div class="stat-card"><small>Total Cm</small><strong id="session_total_len">0</strong></div>
        </div>

        <h6 class="text-muted fs-7 mb-2 text-uppercase fw-bold ps-2">Catch Breakdown</h6>
        <div id="session_breakdown_area"></div>

        <div id="session_verification_box" class="verification-box">
            <h6 class="fw-bold text-primary mb-2"><i class="bi bi-pen-fill me-2"></i>Steward Sign-off</h6>
            <div class="mb-2"><input type="text" id="witnessNameInput" class="form-control" placeholder="Witness Name"></div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="witnessCheckbox">
                <label class="form-check-label small fw-bold text-dark" for="witnessCheckbox">Verified Correct</label>
            </div>
        </div>

        <div class="d-grid gap-3 mt-4">
            <button class="btn btn-primary btn-lg shadow" onclick="window.saveAndEndSession()">
                <i class="bi bi-save me-2"></i> Save & Exit
            </button>
            <button class="btn btn-whatsapp" onclick="window.shareAsImage('live')">
                <i class="bi bi-share-fill me-2"></i> Share
            </button>
        </div>
    </div>

    <div class="modal fade" id="savedModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold text-primary">Scorecard History</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div id="savedScorecardsList"><div id="recentList"></div></div>
                    
                    <div id="fullScorecardView" style="display:none;">
                        <div class="inner-card p-3 mb-3 text-center">
                            <h4 id="saved_view_angler" class="fw-bold text-primary m-0"></h4>
                            <div class="text-muted small"><span id="saved_view_date"></span> • <span id="saved_view_venue"></span></div>
                            <div id="saved_view_comp_details" style="display:none;" class="mt-2 badge bg-primary bg-opacity-10 text-primary">
                                Zone: <span id="saved_view_zone"></span> | Peg: <span id="saved_view_peg"></span>
                            </div>
                            <div id="saved_view_verif" class="mt-2 text-success fw-bold small" style="display:none;"></div>
                        </div>
                        
                        <div class="score-hero-container">
                            <div class="score-hero-label">Total Score</div>
                            <div id="saved_view_points" class="score-hero-val">0</div>
                        </div>

                        <div class="stat-grid">
                            <div id="saved_view_biggest_fish_card" class="stat-card border-success" style="grid-column: span 3; border-color: #86efac; background:#f0fdf4;">
                                <small class="text-success">Biggest Fish</small>
                                <strong id="saved_view_biggest_fish" class="text-success">-</strong>
                            </div>
                            <div class="stat-card"><small>Fish</small><strong id="saved_view_total_fish">0</strong></div>
                            <div class="stat-card"><small>Species</small><strong id="saved_view_species_count">0</strong></div>
                            <div class="stat-card"><small>Total Cm</small><strong id="saved_view_total_len">0</strong></div>
                        </div>

                        <h6 class="text-muted fs-7 mb-2 text-uppercase fw-bold ps-2">Catch Breakdown</h6>
                        <div id="saved_view_breakdown"></div>
                        
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-whatsapp" onclick="window.shareAsImage('saved')">
                                <i class="bi bi-share-fill me-2"></i> Share Image
                            </button>
                            <button class="btn btn-secondary" onclick="window.backToScorecardList()">Back</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SPECIES DATABASE ---
        const speciesList = [
            { category: "Common Species", items: ["Cod", "Pollack", "Coalfish", "Whiting", "Dab", "Flounder", "Plaice", "Turbot", "Dogfish (LSD)", "Bull Huss"] },
            { category: "Round Fish", items: ["Bass", "Bream (Black)", "Bream (Gilthead)", "Bream (Red)", "Garfish", "Gurnard (Grey)", "Gurnard (Red)", "Gurnard (Tub)", "Mackerel", "Mullet (Golden)", "Mullet (Grey/Thick)", "Mullet (Red)", "Scad", "Weever (Lesser)"] },
            { category: "Flatfish", items: ["Brill", "Megrim", "Sole (Dover)", "Sole (Lemon)", "Topknot"] },
            { category: "Wrasse", items: ["Wrasse (Ballan)", "Wrasse (Corkwing)", "Wrasse (Cuckoo)", "Wrasse (Goldsinny)", "Wrasse (Rock Cook)"] },
            { category: "Rockling", items: ["Rockling (3-Bearded)", "Rockling (5-Bearded)", "Rockling (4-Bearded)", "Rockling (Shore)"] },
            { category: "Sharks", items: ["Dogfish (Blackmouth)", "Smoothhound (Common)", "Smoothhound (Starry)", "Spurdog", "Tope"] },
            { category: "Rays & Skates", items: ["Ray (Blonde)", "Ray (Small-eyed)", "Ray (Spotted)", "Ray (Thornback)", "Ray (Undulate)", "Stingray"] },
            { category: "Eels", items: ["Eel (Common)", "Eel (Conger)", "Eel (Silver)"] },
            { category: "Mini / Rare", items: ["Blenny (Common)", "Blenny (Tompot)", "Dragonet", "Goby (Common)", "Goby (Rock)", "Poor Cod", "Pouting (Bib)", "Scorpion Fish", "Squid", "Trigger Fish"] }
        ];

        let fishData=[], currentAngler=null, currentDate=null, currentVenue=null, currentZone=null, currentPeg=null;
        let currentScoringMethod=null, isCompetitionMode=false;

        // --- UTILS ---
        const PageManager={show:function(e){["splashScreen","anglerRegistration","anglerFishingPage","tallyVerificationPage"].forEach(e=>{document.getElementById(e).style.display="none"});document.getElementById(e).style.display="block";window.scrollTo(0,0)}};
        const StorageHelper={save:function(k,v){try{localStorage.setItem(k,v)}catch(e){}},get:function(k){try{return localStorage.getItem(k)}catch(e){return null}},remove:function(k){try{localStorage.removeItem(k)}catch(e){}},getAll:function(){const r={};try{for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k.startsWith("scorecard_"))r[k]=localStorage.getItem(k)}}catch(e){}return r}};

        window.formatDate=function(d){try{return d?new Date(d).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"N/A"}catch(e){return"N/A"}};
        window.startFishing=function(){
            fishData=[]; document.getElementById("anglerName").value=""; 
            
            // SAFE AUTO DATE
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                document.getElementById("competitionDate").value = `${year}-${month}-${day}`;
            } catch(e) { console.log("Date auto-fill skipped"); }

            document.getElementById("venueInput").value="";
            PageManager.show("anglerRegistration");
        };

        window.checkRuleInfo=function(){
            const m=document.getElementById("scoringMethod").value;
            const ids=["speciesHuntInfo","measurePointsInfo"];
            ids.forEach(i=>document.getElementById(i).style.display='none');
            
            if(m==="species_hunt") document.getElementById("speciesHuntInfo").style.display='block';
            else if(m==="measure_points") document.getElementById("measurePointsInfo").style.display='block';
        };

        window.populateSpeciesDropdown=function(){
            const sel=document.getElementById("speciesInput");
            sel.innerHTML='<option value="" selected>Select Fish...</option><option value="Other">Other (specify)</option>';
            
            speciesList.forEach(grp=>{
                const optgroup = document.createElement('optgroup');
                optgroup.label = grp.category;
                grp.items.sort().forEach(f=>{
                    const opt = document.createElement('option');
                    opt.value=f; opt.textContent=f;
                    optgroup.appendChild(opt);
                });
                sel.appendChild(optgroup);
            });
        };

        // --- SCORING ---
        window.calculatePoints=function(data, method){
            if(method==='species_hunt'){
                const c={}; let t=0;
                data.forEach(f=>{
                    if(!c[f.species])c[f.species]=0; c[f.species]++;
                    const n=c[f.species];
                    if(n===1)t+=30; else if(n===2)t+=30; else if(n===3)t+=40; else t+=1;
                });
                return t;
            } else if(method==='length_only'){
                return Math.round(data.reduce((a,b)=>a+parseFloat(b.length||0),0));
            } else {
                // Length + 10
                const len=data.reduce((a,b)=>a+parseFloat(b.length||0),0);
                return Math.round((data.length*10)+len);
            }
        };

        // --- FLOW ---
        window.registerAngler=function(){
            const name=document.getElementById("anglerName").value.trim();
            const date=document.getElementById("competitionDate").value;
            const venue=document.getElementById("venueInput").value.trim();
            const method=document.getElementById("scoringMethod").value;
            const isComp=document.getElementById("isCompetition").checked;

            if(!method) return alert("Select Scoring Method");
            if(!name||!date||!venue) return alert("Fill in Name, Date and Venue");

            currentAngler=name; currentDate=date; currentVenue=venue;
            currentScoringMethod=method; isCompetitionMode=isComp;
            
            if(isComp){
                currentZone=document.getElementById("zoneInput").value;
                currentPeg=document.getElementById("pegInput").value;
            } else { currentZone="-"; currentPeg="-"; }

            fishData=[];
            window.populateSpeciesDropdown();
            
            const lenBox=document.getElementById('lengthInputContainer');
            const spBtn=document.getElementById('speciesHuntAddBtn');
            if(method==='species_hunt'){ lenBox.style.display='none'; spBtn.style.display='block'; }
            else { lenBox.style.display='flex'; spBtn.style.display='none'; }

            PageManager.show('anglerFishingPage');
            window.updateFishLog();
        };

        window.addFish=function(){
            const sIn=document.getElementById("speciesInput");
            const cIn=document.getElementById("customSpeciesInput");
            const lIn=document.getElementById("lengthInput");
            
            let sp=sIn.value;
            if(sp==="Other") sp=cIn.value.trim();
            if(!sp) return alert("Select Species");
            
            let len=parseFloat(lIn.value);
            if(currentScoringMethod!=='species_hunt'){
                if(isNaN(len)||len<=0) return alert("Enter Length");
            } else { len=0; }
            
            fishData.push({species:sp, length:len});
            window.updateFishLog();
            
            sIn.value=""; cIn.value=""; lIn.value="";
            window.toggleCustomSpeciesInput();
        };

        window.updateFishLog=function(){
            const log=document.getElementById("fishLog");
            log.innerHTML="";
            
            const badges=[];
            const spCounts={};
            fishData.forEach(f=>{
                if(!spCounts[f.species]) spCounts[f.species]=0;
                spCounts[f.species]++;
                const c=spCounts[f.species];
                if(currentScoringMethod==='species_hunt'){
                    if(c===1) badges.push({lbl:"1st: Starter (+30)", cls:"bg-success"});
                    else if(c===2) badges.push({lbl:"2nd: Builder (+30)", cls:"bg-info text-dark"});
                    else if(c===3) badges.push({lbl:"3rd: Full House (+40)", cls:"bg-warning text-dark"});
                    else badges.push({lbl:"Extra (+1)", cls:"bg-secondary"});
                } else {
                    badges.push({lbl:`${f.length} cm`, cls:"bg-transparent text-primary fs-5"});
                }
            });

            [...fishData].reverse().forEach((f, revIdx)=>{
                const realIdx = fishData.length - 1 - revIdx;
                const b = badges[realIdx];
                const row=document.createElement("tr");
                let displayHtml = (currentScoringMethod==='species_hunt') ? 
                    `<span class="badge ${b.cls}" style="font-size:0.8rem;">${b.lbl}</span>` :
                    `<span class="fw-bold fs-5 text-primary">${f.length} cm</span>`;

                row.innerHTML=`
                    <td class="align-middle"><div class="fw-bold text-dark">${f.species}</div>${displayHtml}</td>
                    <td class="text-end align-middle"><button class="btn btn-sm btn-outline-danger border-0" onclick="window.deleteFish(${realIdx})"><i class="bi bi-trash"></i></button></td>
                `;
                log.appendChild(row);
            });
        };

        window.deleteFish=function(i){
            if(confirm("Delete this fish?")){
                fishData.splice(i,1);
                window.updateFishLog();
            }
        };

        window.endSession=function(){
            PageManager.show('tallyVerificationPage');
            
            document.getElementById('session_angler').textContent=currentAngler;
            document.getElementById('session_date').textContent=window.formatDate(currentDate);
            document.getElementById('session_venue').textContent=currentVenue;
            
            const compBox=document.getElementById('session_comp_details');
            const verifBox=document.getElementById('session_verification_box');
            if(isCompetitionMode){
                compBox.style.display='inline-block';
                document.getElementById('session_zone').textContent=currentZone;
                document.getElementById('session_peg').textContent=currentPeg;
                verifBox.style.display='block';
            } else {
                compBox.style.display='none';
                verifBox.style.display='none';
            }
            
            const bigFishBox=document.getElementById('session_biggest_fish_card');
            if(currentScoringMethod==='species_hunt') bigFishBox.style.display='none';
            else bigFishBox.style.display='block';
            
            const pts=window.calculatePoints(fishData, currentScoringMethod);
            document.getElementById('session_total_points').textContent=pts;
            document.getElementById('session_total_fish').textContent=fishData.length;
            document.getElementById('session_species_count').textContent=new Set(fishData.map(f=>f.species)).size;
            document.getElementById('session_total_len').textContent=fishData.reduce((a,b)=>a+parseFloat(b.length||0),0).toFixed(1);
            
            let max=0, name="-";
            fishData.forEach(f=>{if(f.length>max){max=f.length; name=`${f.species} (${f.length}cm)`}});
            document.getElementById('session_biggest_fish').textContent=name;
            
            const container=document.getElementById('session_breakdown_area');
            container.innerHTML='';
            
            if(currentScoringMethod==='species_hunt'){
                const counts={};
                fishData.forEach(f=>{ if(!counts[f.species]) counts[f.species]=0; counts[f.species]++; });
                for(const sp in counts){
                    const c = counts[sp];
                    let rowPts = 0;
                    let pipsHtml = '';
                    for(let i=1; i<=3; i++){
                        let act = c>=i ? 'active' : '';
                        let gold = i===3 ? 'gold' : '';
                        let val = (i===1||i===2)?30:40;
                        if(c>=i) rowPts += val;
                        pipsHtml += `<span class="pip ${gold} ${act}">${val}</span>`;
                    }
                    let extraHtml='';
                    if(c>3){ const ex = c-3; rowPts += ex; extraHtml = `<span class="pip-extra">+${ex} extra</span>`; }
                    container.innerHTML += `<div class="species-quota-card"><div class="sq-header"><span class="sq-name">${sp}</span><span class="sq-points">${rowPts} pts</span></div><div class="sq-pips">${pipsHtml}${extraHtml}</div></div>`;
                }
            } else {
                let html='<table class="table-custom"><thead><tr><th class="ps-3 small text-muted">SPECIES</th><th class="text-center small text-muted">QTY</th><th class="text-end pe-3 small text-muted">LENGTHS</th></tr></thead><tbody>';
                const sum={};
                fishData.forEach(f=>{ if(!sum[f.species]) sum[f.species]={c:0, l:[]}; sum[f.species].c++; sum[f.species].l.push(f.length); });
                for(const sp in sum){ html+=`<tr><td class="fw-bold">${sp}</td><td class="text-center"><span class="badge bg-secondary rounded-pill">${sum[sp].c}</span></td><td class="text-end small text-muted">${sum[sp].l.join(', ')}</td></tr>`; }
                html+='</tbody></table>';
                container.innerHTML=html;
            }
        };

        window.saveAndEndSession=function(){
            const wit=document.getElementById("witnessNameInput").value;
            const ver=document.getElementById("witnessCheckbox").checked;
            
            const record = {
                angler: currentAngler, date: currentDate, venue: currentVenue,
                scoringMethod: currentScoringMethod, isComp: isCompetitionMode,
                zone: currentZone, peg: currentPeg, fishData: fishData, witness: wit, verified: ver
            };
            
            StorageHelper.save(`scorecard_${Date.now()}`, JSON.stringify(record));
            window.resetApp();
        };

        window.loadSavedScorecards=function(){
            const list=document.getElementById('recentList'); list.innerHTML='';
            const all=StorageHelper.getAll();
            Object.keys(all).sort().reverse().forEach(k=>{
                if(k.startsWith("scorecard_")){
                    const d=JSON.parse(all[k]);
                    const pts = window.calculatePoints(d.fishData, d.scoringMethod);
                    list.innerHTML += `<div class="inner-card p-3 mb-2" onclick="window.viewSaved('${k}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div><div class="fw-bold text-dark">${d.venue}</div><div class="small text-muted">${window.formatDate(d.date)} <span class="badge bg-primary bg-opacity-10 text-primary ms-2">${pts} pts</span></div></div>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>`;
                }
            });
        };

        window.viewSaved=function(k){
            const d=JSON.parse(StorageHelper.get(k));
            if(!d) return;
            
            document.getElementById('saved_view_angler').textContent = d.angler;
            document.getElementById('saved_view_date').textContent = window.formatDate(d.date);
            document.getElementById('saved_view_venue').textContent = d.venue;
            
            if(d.isComp){
                document.getElementById('saved_view_comp_details').style.display='inline-block';
                document.getElementById('saved_view_zone').textContent = d.zone;
                document.getElementById('saved_view_peg').textContent = d.peg;
            } else {
                document.getElementById('saved_view_comp_details').style.display='none';
            }

            const pts = window.calculatePoints(d.fishData, d.scoringMethod);
            document.getElementById('saved_view_points').textContent = pts;
            
            // Saved Stats Logic
            document.getElementById('saved_view_total_fish').textContent = d.fishData.length;
            document.getElementById('saved_view_species_count').textContent = new Set(d.fishData.map(f=>f.species)).size;
            document.getElementById('saved_view_total_len').textContent = d.fishData.reduce((a,b)=>a+parseFloat(b.length||0),0).toFixed(1);
            
            const bigFishBox = document.getElementById('saved_view_biggest_fish_card');
            if(d.scoringMethod==='species_hunt') bigFishBox.style.display='none';
            else {
                bigFishBox.style.display='block';
                let max=0, name="-";
                d.fishData.forEach(f=>{if(f.length>max){max=f.length; name=`${f.species} (${f.length}cm)`}});
                document.getElementById('saved_view_biggest_fish').textContent=name;
            }

            const vDiv = document.getElementById('saved_view_verif');
            if(d.isComp && d.verified) { vDiv.style.display='block'; vDiv.textContent=`Verified by: ${d.witness}`; }
            else { vDiv.style.display='none'; }
            
            const container = document.getElementById('saved_view_breakdown');
            container.innerHTML = '';
            
            if(d.scoringMethod === 'species_hunt') {
                const counts={};
                d.fishData.forEach(f=>{ if(!counts[f.species]) counts[f.species]=0; counts[f.species]++; });
                for(const sp in counts){
                    const c=counts[sp];
                    let rowPts=0;
                    let pipsHtml='';
                    for(let i=1; i<=3; i++) { 
                        let act=c>=i?'active':''; let gold=i===3?'gold':''; let val=(i===1||i===2)?30:40; 
                        if(c>=i) rowPts+=val;
                        pipsHtml+=`<span class="pip ${gold} ${act}">${val}</span>`;
                    }
                    if(c>3) { rowPts+=(c-3); pipsHtml+=`<span class="pip-extra">+${c-3} extra</span>`; }
                    container.innerHTML += `<div class="species-quota-card"><div class="sq-header"><span class="sq-name">${sp}</span><span class="sq-points">${rowPts} pts</span></div><div class="sq-pips">${pipsHtml}</div></div>`;
                }
            } else {
                let h='<table class="table-custom"><tbody>';
                d.fishData.forEach(f=>{ h+=`<tr><td>${f.species}</td><td class="text-end fw-bold">${f.length} cm</td></tr>`; });
                h+='</tbody></table>';
                container.innerHTML=h;
            }

            document.getElementById('savedScorecardsList').style.display='none';
            document.getElementById('fullScorecardView').style.display='block';
        };

        window.backToScorecardList=function(){
            document.getElementById('fullScorecardView').style.display='none';
            document.getElementById('savedScorecardsList').style.display='block';
        };

        window.toggleCustomSpeciesInput=function(){
            const v=document.getElementById("speciesInput").value;
            document.getElementById("customSpeciesInput").style.display = (v==="Other")?"block":"none";
        };
        
        window.toggleCompetitionFields=function(){
            const c=document.getElementById("isCompetition").checked;
            document.getElementById("zoneInput").disabled=!c;
            document.getElementById("pegInput").disabled=!c;
        };

        window.resetApp=function(){ window.location.reload(); };
        window.confirmQuit=function(){ if(confirm("End session without saving?")) window.resetApp(); };
        window.shareAsImage=function(ctx){
            const el = document.getElementById(ctx==='live'?'tallyVerificationPage':'fullScorecardView');
            const btns = el.querySelectorAll('button');
            btns.forEach(b=>b.style.display='none');
            html2canvas(el, {backgroundColor:'#f0f4f8'}).then(c=>{
                btns.forEach(b=>b.style.display='');
                c.toBlob(b=>{
                    const f=new File([b],"scorecard.png",{type:"image/png"});
                    if(navigator.share) navigator.share({files:[f]});
                    else { const l=document.createElement('a'); l.download='score.png'; l.href=c.toDataURL(); l.click(); }
                });
            });
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
