<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Sea Score</title>
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #0f172a; 
            --accent-color: #0ea5e9; 
            --bg-gradient: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%);
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: #1e293b; padding-bottom: 80px; min-height: 100vh; }
        h1, h2, h3, h4, .btn { font-family: 'Poppins', sans-serif; }

        /* ANIMATED LOGO */
        .logo-svg { width: 140px; height: 140px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2)); margin-bottom: 25px; }
        .radar-sweep { transform-origin: 100px 100px; animation: scan 4s linear infinite; }
        @keyframes scan { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* SPLASH */
        .splash-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white;
            text-align: center; padding: 20px;
        }

        /* LAYOUT */
        .app-page { display: none; max-width: 600px; margin: 10px auto; padding: 15px; }
        .inner-card { background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.8); }

        /* CONTROLS */
        .form-label { font-weight: 700; color: var(--primary-color); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px; }
        .form-control, .form-select { border-radius: 12px; padding: 12px; font-weight: 500; border: 1px solid #cbd5e1; background: #f8fafc; }
        .form-control:focus, .form-select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); }
        
        /* BUTTONS */
        .btn { border-radius: 50px; padding: 12px; font-weight: 700; text-transform: uppercase; border: none; font-size: 0.9rem; }
        .btn-primary { background: linear-gradient(to right, #0f172a, #334155); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-camera { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }

        /* SCORE DISPLAY */
        .score-hero-container { background: white; border-radius: 20px; padding: 15px; text-align: center; box-shadow: var(--shadow); margin-bottom: 15px; }
        .score-hero-val { font-size: 3rem; font-weight: 800; color: var(--primary-color); line-height: 1; }
        
        /* STATS GRID */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 8px; border-radius: 12px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-card small { display: block; color: #64748b; font-size: 0.6rem; text-transform: uppercase; font-weight: 700; }
        .stat-card strong { font-size: 1rem; color: #1e293b; font-weight: 700; }

        /* LISTS */
        .table-custom { width: 100%; border-collapse: separate; border-spacing: 0 6px; }
        .table-custom td { background: white; padding: 10px 15px; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .table-custom tr td:first-child { border-left: 1px solid #f1f5f9; border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        .table-custom tr td:last-child { border-right: 1px solid #f1f5f9; border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
        .fish-thumb { width: 32px; height: 32px; object-fit: cover; border-radius: 6px; border: 1px solid #e2e8f0; margin-left: 8px; cursor: pointer; }

        /* SPECIES PIPS */
        .species-quota-card { background: white; border-radius: 16px; padding: 10px 15px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
        .sq-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .sq-pips { display: flex; align-items: center; gap: 5px; }
        .pip { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; background: #f1f5f9; color: #94a3b8; }
        .pip.bronze.active { background: #d97706; color: white; }
        .pip.silver.active { background: #94a3b8; color: white; }
        .pip.gold.active { background: #eab308; color: white; }

        /* MISC */
        .verification-box { display: none; background-color: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 12px; margin-top: 20px; }
        .btn-card-icon { width: 32px; height: 32px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; margin-left: 5px; }
        .btn-card-icon.delete { background: #fef2f2; color: #ef4444; }
        .btn-card-icon.view { background: #eff6ff; color: var(--primary-color); }
    </style>
</head>
<body>
    <div id="splashScreen" class="splash-screen">
        <svg class="logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            <circle cx="100" cy="100" r="90" fill="#f0f9ff" stroke="#0ea5e9" stroke-width="2" stroke-dasharray="10,5"/>
            <circle cx="100" cy="100" r="65" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
            <circle cx="100" cy="100" r="40" fill="#0ea5e9"/>
            <path d="M75,100 Q90,80 115,85 Q130,90 135,100 Q130,110 115,115 Q90,120 75,100" fill="white"/>
            <path d="M75,100 L65,90 L65,110 Z" fill="white"/>
            <g class="radar-sweep"><line x1="100" y1="100" x2="160" y2="40" stroke="#10b981" stroke-width="4" stroke-linecap="round" opacity="0.8"/><circle cx="160" cy="40" r="5" fill="#10b981"/></g>
        </svg>
        <h1 class="mb-1 display-5 fw-bold">Sea Score</h1>
        <p class="version-tag text-uppercase letter-spacing-2 opacity-50 small">Version 93.0</p>
        <div class="d-grid gap-3 col-10 col-md-6 mt-4">
            <button class="btn btn-light btn-lg text-primary fw-bold shadow-lg" onclick="window.startFishing()">Start Fishing</button>
            <button class="btn btn-outline-light btn-lg fw-bold" onclick="window.loadSavedScorecards()" data-bs-toggle="modal" data-bs-target="#savedModal">Scorecards</button>
            <button id="btnInstall" class="btn btn-info btn-sm rounded-pill mt-2 text-white fw-bold" style="display:none;">Install App</button>
        </div>
    </div>

    <div id="anglerRegistration" class="app-page">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4 fw-bold m-0 text-primary">New Session</h2>
        </div>
        
        <div class="inner-card">
            <div class="mb-3">
                <label class="form-label">Angler Name</label>
                <input type="text" id="anglerName" class="form-control" placeholder="Your Name" oninput="window.saveActiveSession()">
            </div>
            <div class="row g-2">
                <div class="col-6"><label class="form-label">Date</label><input type="date" id="competitionDate" class="form-control" onchange="window.saveActiveSession()"></div>
                <div class="col-6"><label class="form-label">Venue</label><input type="text" id="venueInput" class="form-control" placeholder="Location" oninput="window.saveActiveSession()"></div>
            </div>
        </div>

        <div class="inner-card">
            <label class="form-label">Scoring Method</label>
            <select id="scoringMethod" class="form-select mb-3" onchange="window.checkRuleInfo(); window.saveActiveSession();">
                <option value="" disabled selected>Select Rules...</option>
                <option value="measure_points">Length + 10 Pts</option>
                <option value="length_only">Total Length Only</option>
                <option value="species_hunt">Species Hunt (3=100pts)</option>
            </select>
            
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="isCompetition" onchange="window.toggleCompetitionFields(); window.saveActiveSession();">
                <label class="form-check-label fw-bold text-dark small" for="isCompetition">Competition Mode (Zone/Peg)</label>
            </div>
            <div class="row g-2">
                <div class="col-6"><select id="zoneInput" class="form-select form-select-sm" disabled onchange="window.saveActiveSession()"><option selected>Zone</option><option>1</option><option>2</option><option>3</option><option>4</option><option>Red</option><option>Yellow</option><option>Green</option><option>Blue</option></select></div>
                <div class="col-6"><select id="pegInput" class="form-select form-select-sm" disabled onchange="window.saveActiveSession()"><option selected>Peg</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option><option>13</option><option>14</option><option>15</option><option>16</option><option>17</option><option>18</option><option>19</option><option>20</option></select></div>
            </div>
        </div>

        <div class="d-flex gap-3 mt-4">
            <button class="btn btn-secondary flex-grow-1" onclick="window.resetApp()">Reset</button>
            <button class="btn btn-primary flex-grow-1 shadow" onclick="window.registerAngler()">Let's Fish <i class="bi bi-arrow-right"></i></button>
        </div>
    </div>

    <div id="anglerFishingPage" class="app-page">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="m-0 fw-bold text-primary">Live Catch</h4>
            <button class="btn btn-sm btn-outline-danger rounded-pill px-3" onclick="window.confirmQuit()">Quit</button>
        </div>
        
        <div class="inner-card mb-3" style="background: #f8fafc;">
            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="window.handleCameraInput()">

            <div class="mb-3">
                <label class="form-label text-primary">Species</label>
                <select id="speciesInput" class="form-select form-select-lg" onchange="window.toggleCustomSpeciesInput()"><option value="" selected>Select Fish...</option></select>
                <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter Name" style="display:none;">
            </div>
            
            <div class="mb-3" id="lengthInputContainer">
                <label class="form-label text-primary">Length (cm)</label>
                <input type="number" id="lengthInput" class="form-control form-control-lg" placeholder="0">
            </div>
            
            <div class="row g-2">
                <div class="col-6">
                    <button class="btn btn-camera w-100 py-3 shadow-sm" onclick="window.triggerCamera()">
                        <i class="bi bi-camera-fill me-1"></i> Snap & Add
                    </button>
                </div>
                <div class="col-6">
                    <button class="btn btn-success w-100 py-3 shadow-sm" onclick="window.addFishTextOnly()">
                        <i class="bi bi-plus-lg me-1"></i> Add Text
                    </button>
                </div>
            </div>
        </div>

        <h5 class="text-muted fs-7 text-uppercase fw-bold letter-spacing-1 ps-2">Haul History</h5>
        <div class="table-responsive mb-4">
            <table class="table-custom"><tbody id="fishLog"></tbody></table>
        </div>
        
        <button class="btn btn-danger w-100 py-3 shadow" onclick="window.endSession()">Finish Session</button>
    </div>

    <div id="tallyVerificationPage" class="app-page">
        <div class="inner-card p-3 mb-3 text-center">
            <h2 class="h3 fw-bold mb-0 text-primary">Complete</h2>
            <div id="session_angler" class="fw-bold text-dark mt-1"></div>
            <div class="text-muted small mt-1"><span id="session_date"></span> • <span id="session_venue"></span></div>
            <div id="session_comp_details" style="display:none;" class="mt-2 badge bg-primary bg-opacity-10 text-primary">Zone: <span id="session_zone"></span> | Peg: <span id="session_peg"></span></div>
        </div>

        <div class="score-hero-container">
            <div class="score-hero-label">Total Points</div>
            <div id="session_total_points" class="score-hero-val">0</div>
        </div>

        <div class="stat-grid">
            <div id="session_biggest_fish_card" class="stat-card border-success" style="grid-column: span 3; border-color: #86efac; background:#f0fdf4;"><small class="text-success">Biggest Fish</small><strong id="session_biggest_fish" class="text-success">-</strong></div>
            <div class="stat-card"><small>Fish</small><strong id="session_total_fish">0</strong></div>
            <div class="stat-card"><small>Species</small><strong id="session_species_count">0</strong></div>
            <div class="stat-card"><small>Total Cm</small><strong id="session_total_len">0</strong></div>
        </div>

        <h6 class="text-muted fs-7 mb-2 text-uppercase fw-bold ps-2">Catch Breakdown</h6>
        <div id="session_breakdown_area"></div>

        <div class="inner-card p-3 mt-3">
            <label class="form-label text-muted small"><i class="bi bi-journal-text me-1"></i>Session Notes</label>
            <textarea id="sessionNotesInput" class="form-control" rows="2" placeholder="Add notes..." oninput="window.saveActiveSession()"></textarea>
        </div>

        <div id="session_verification_box" class="verification-box">
            <h6 class="fw-bold text-primary mb-2"><i class="bi bi-pen-fill me-2"></i>Steward Sign-off</h6>
            <div class="mb-2"><input type="text" id="witnessNameInput" class="form-control" placeholder="Witness Name"></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="witnessCheckbox"><label class="form-check-label small fw-bold text-dark" for="witnessCheckbox">Verified Correct</label></div>
        </div>

        <div class="d-grid gap-3 mt-4">
            <button class="btn btn-primary btn-lg shadow" onclick="window.saveAndEndSession()">
                <i class="bi bi-save me-2"></i> Save Scorecard
            </button>
            <button class="btn btn-whatsapp" onclick="window.shareAsImage('live')">
                <i class="bi bi-share-fill me-2"></i> Share
            </button>
        </div>
    </div>

    <div class="modal fade" id="savedModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold text-primary">History</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div id="savedScorecardsList"><div id="recentList"></div></div>
                    <div id="fullScorecardView" style="display:none;">
                        <div class="inner-card p-3 mb-3 text-center">
                            <h4 id="saved_view_angler" class="fw-bold text-primary m-0"></h4>
                            <div class="text-muted small"><span id="saved_view_date"></span> • <span id="saved_view_venue"></span></div>
                            <div id="saved_view_comp_details" style="display:none;" class="mt-2 badge bg-primary bg-opacity-10 text-primary">Zone: <span id="saved_view_zone"></span> | Peg: <span id="saved_view_peg"></span></div>
                            <div id="saved_view_verif" class="mt-2 text-success fw-bold small" style="display:none;"></div>
                        </div>
                        <div class="score-hero-container"><div class="score-hero-label">Total Score</div><div id="saved_view_points" class="score-hero-val">0</div></div>
                        <div class="stat-grid">
                            <div id="saved_view_biggest_fish_card" class="stat-card border-success" style="grid-column: span 3; border-color: #86efac; background:#f0fdf4;"><small class="text-success">Biggest Fish</small><strong id="saved_view_biggest_fish" class="text-success">-</strong></div>
                            <div class="stat-card"><small>Fish</small><strong id="saved_view_total_fish">0</strong></div>
                            <div class="stat-card"><small>Species</small><strong id="saved_view_species_count">0</strong></div>
                            <div class="stat-card"><small>Total Cm</small><strong id="saved_view_total_len">0</strong></div>
                        </div>
                        <h6 class="text-muted fs-7 mb-2 text-uppercase fw-bold ps-2">Catch Breakdown</h6>
                        <div id="saved_view_breakdown"></div>
                        <div class="inner-card p-3 mt-3" style="background:#fffbeb; border-color:#fef3c7;"><label class="form-label text-muted small mb-1"><i class="bi bi-journal-text me-1"></i>Notes</label><textarea id="saved_view_notes_input" class="form-control" rows="2"></textarea><button class="btn btn-sm btn-warning w-100 mt-2 text-dark fw-bold" onclick="window.updateSavedNote()">Update Note</button></div>
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-whatsapp" onclick="window.shareAsImage('saved')"><i class="bi bi-share-fill me-2"></i> Share Image</button>
                            <button class="btn btn-danger" onclick="window.deleteCurrentSaved()"><i class="bi bi-trash me-2"></i> Delete</button>
                            <button class="btn btn-secondary" onclick="window.backToScorecardList()">Back</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background:transparent; border:none;">
                <div class="modal-body p-0 text-center">
                    <img id="fullSizeImage" src="" style="max-width:100%; border-radius:12px; border:2px solid white;">
                    <button class="btn btn-sm btn-light mt-3 rounded-pill px-4" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="restoreSessionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-body text-center p-4">
                    <div class="mb-3 text-primary"><i class="bi bi-clock-history fs-1"></i></div>
                    <h4 class="mb-2 fw-bold">Resume Session?</h4>
                    <p class="text-muted mb-4">Unfinished session found.</p>
                    <div class="d-grid gap-2"><button class="btn btn-primary" onclick="window.confirmRestore()">Resume</button><button class="btn btn-outline-secondary" onclick="window.discardRestore()">Start New</button></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const speciesList=[{category:"Common Species",items:["Cod","Pollack","Coalfish","Whiting","Dab","Flounder","Plaice","Turbot","Dogfish (LSD)","Bull Huss"]},{category:"Round Fish",items:["Bass","Bream (Black)","Bream (Gilthead)","Bream (Red)","Garfish","Gurnard (Grey)","Gurnard (Red)","Gurnard (Tub)","Mackerel","Mullet (Golden)","Mullet (Grey/Thick)","Mullet (Red)","Scad","Weever (Lesser)"]},{category:"Flatfish",items:["Brill","Megrim","Sole (Dover)","Sole (Lemon)","Topknot"]},{category:"Wrasse",items:["Wrasse (Ballan)","Wrasse (Corkwing)","Wrasse (Cuckoo)","Wrasse (Goldsinny)","Wrasse (Rock Cook)"]},{category:"Rockling",items:["Rockling (3-Bearded)","Rockling (5-Bearded)","Rockling (4-Bearded)","Rockling (Shore)"]},{category:"Sharks",items:["Dogfish (Blackmouth)","Smoothhound (Common)","Smoothhound (Starry)","Spurdog","Tope"]},{category:"Rays & Skates",items:["Ray (Blonde)","Ray (Small-eyed)","Ray (Spotted)","Ray (Thornback)","Ray (Undulate)","Stingray"]},{category:"Eels",items:["Eel (Common)","Eel (Conger)","Eel (Silver)"]},{category:"Mini / Rare",items:["Blenny (Common)","Blenny (Tompot)","Dragonet","Goby (Common)","Goby (Rock)","Poor Cod","Pouting (Bib)","Scorpion Fish","Squid","Trigger Fish"]}];
        let fishData=[],currentAngler=null,currentDate=null,currentVenue=null,currentZone=null,currentPeg=null,currentScoringMethod=null,isCompetitionMode=!1,currentSavedKey=null,pendingRestoreData=null;

        const PageManager={show:function(e){["splashScreen","anglerRegistration","anglerFishingPage","tallyVerificationPage"].forEach(e=>{document.getElementById(e).style.display="none"});document.getElementById(e).style.display="block";window.scrollTo(0,0)}};
        const StorageHelper={save:function(e,t){try{localStorage.setItem(e,t)}catch(e){}},get:function(e){try{return localStorage.getItem(e)}catch(e){return null}},remove:function(e){try{localStorage.removeItem(e)}catch(e){}},getAll:function(){const e={};try{for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);(n.startsWith("scorecard_")||"active_session"===n)&&(e[n]=localStorage.getItem(n))}}catch(e){}return e}};

        window.formatDate=function(e){try{return e?new Date(e).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"N/A"}catch(e){return"N/A"}};
        window.startFishing=function(){document.getElementById("anglerName").value="";try{const e=new Date,t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");document.getElementById("competitionDate").value=`${t}-${n}-${a}`}catch(e){}document.getElementById("venueInput").value="";PageManager.show("anglerRegistration");};

        // --- NEW CAMERA LOGIC (SLEEK) ---
        window.validateInputs = function() {
            const e = document.getElementById("speciesInput"), t = document.getElementById("customSpeciesInput"), n = document.getElementById("lengthInput");
            let a = e.value; if ("Other" === a) a = t.value.trim();
            if (!a) { alert("Please select a species first."); return null; }
            let o = parseFloat(n.value);
            if ("species_hunt" !== currentScoringMethod) {
                if (isNaN(o) || o <= 0) { alert("Please enter a valid length."); return null; }
            } else { o = 0; }
            return { species: a, length: o };
        };

        window.triggerCamera = function() {
            if(window.validateInputs()) {
                document.getElementById('cameraInput').click();
            }
        };

        window.handleCameraInput = function() {
            const input = document.getElementById('cameraInput');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX = 600; 
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } } else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        const photoData = canvas.toDataURL('image/jpeg', 0.6);
                        
                        // AUTO ADD FISH WITH PHOTO
                        const data = window.validateInputs();
                        if(data) {
                            fishData.push({ species: data.species, length: data.length, photo: photoData });
                            finishAddAction();
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = ''; // Reset input
        };

        window.addFishTextOnly = function() {
            const data = window.validateInputs();
            if(data) {
                fishData.push({ species: data.species, length: data.length, photo: null });
                finishAddAction();
            }
        };

        function finishAddAction() {
            window.updateFishLog();
            document.getElementById("speciesInput").value = "";
            document.getElementById("customSpeciesInput").value = "";
            document.getElementById("lengthInput").value = "";
            window.toggleCustomSpeciesInput();
            window.saveActiveSession();
        }

        // --- CORE LOGIC ---
        window.saveActiveSession=function(){
            let p='setup';
            if(document.getElementById('anglerFishingPage').style.display==='block')p='fishing';
            if(document.getElementById('tallyVerificationPage').style.display==='block')p='tally';
            const d={phase:p,angler:document.getElementById("anglerName").value,date:document.getElementById("competitionDate").value,venue:document.getElementById("venueInput").value,method:document.getElementById("scoringMethod").value,isComp:document.getElementById("isCompetition").checked,zone:document.getElementById("zoneInput").value,peg:document.getElementById("pegInput").value,fishData:fishData,notes:document.getElementById("sessionNotesInput").value};
            StorageHelper.save('active_session',JSON.stringify(d));
        };
        window.restoreActiveSession=function(){const s=JSON.parse(StorageHelper.get('active_session'));if(s&&(s.angler||s.fishData.length>0)){pendingRestoreData=s;new bootstrap.Modal(document.getElementById('restoreSessionModal')).show()}};
        window.confirmRestore=function(){const d=pendingRestoreData;fishData=d.fishData||[];currentAngler=d.angler;currentDate=d.date;currentVenue=d.venue;currentScoringMethod=d.method;isCompetitionMode=d.isComp;currentZone=d.zone;currentPeg=d.peg;document.getElementById("anglerName").value=d.angler;document.getElementById("competitionDate").value=d.date;document.getElementById("venueInput").value=d.venue;document.getElementById("scoringMethod").value=d.method;document.getElementById("isCompetition").checked=d.isComp;document.getElementById("zoneInput").value=d.zone;document.getElementById("pegInput").value=d.peg;document.getElementById("sessionNotesInput").value=d.notes||"";window.populateSpeciesDropdown();window.toggleCompetitionFields();window.checkRuleInfo();if(d.phase==='fishing'){window.setupFishingUI();PageManager.show('anglerFishingPage');window.updateFishLog()}else if(d.phase==='tally'){window.endSession()}else{PageManager.show('anglerRegistration')}document.querySelector('.btn-close').click()};
        window.discardRestore=function(){StorageHelper.remove('active_session');window.startFishing();document.querySelector('.btn-close').click()};

        window.checkRuleInfo=function(){const e=document.getElementById("scoringMethod").value,t=["speciesHuntInfo","measurePointsInfo"];t.forEach(e=>document.getElementById(e).style.display="none"),"species_hunt"===e?document.getElementById("speciesHuntInfo").style.display="block":"measure_points"===e&&(document.getElementById("measurePointsInfo").style.display="block")};
        window.populateSpeciesDropdown=function(){const e=document.getElementById("speciesInput");e.innerHTML='<option value="" selected>Select Fish...</option><option value="Other">Other (specify)</option>',speciesList.forEach(t=>{const n=document.createElement("optgroup");n.label=t.category,t.items.sort().forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t,n.appendChild(a)}),e.appendChild(n)})};
        window.calculatePoints=function(e,t){if("species_hunt"===t){const n={};let a=0;return e.forEach(e=>{n[e.species]||(n[e.species]=0),n[e.species]++;const t=n[e.species];1===t?a+=30:2===t?a+=30:3===t?a+=40:a+=1}),a}if("length_only"===t)return Math.round(e.reduce((e,t)=>e+parseFloat(t.length||0),0));{const n=e.reduce((e,t)=>e+parseFloat(t.length||0),0);return Math.round(10*e.length+n)}};
        
        window.registerAngler=function(){const e=document.getElementById("anglerName").value.trim(),t=document.getElementById("competitionDate").value,n=document.getElementById("venueInput").value.trim(),a=document.getElementById("scoringMethod").value,o=document.getElementById("isCompetition").checked;if(!a)return alert("Select Scoring Method");if(!e||!t||!n)return alert("Fill in Name, Date and Venue");currentAngler=e,currentDate=t,currentVenue=n,currentScoringMethod=a,isCompetitionMode=o,o?(currentZone=document.getElementById("zoneInput").value,currentPeg=document.getElementById("pegInput").value):(currentZone="-",currentPeg="-"),fishData=[],window.populateSpeciesDropdown();window.setupFishingUI();PageManager.show("anglerFishingPage"),window.updateFishLog();window.saveActiveSession()};
        window.setupFishingUI=function(){const e=document.getElementById("lengthInputContainer");"species_hunt"===currentScoringMethod?e.style.display="none":e.style.display="block"}; // Note: Button visibility handled statically now
        
        window.updateFishLog=function(){
            const e=document.getElementById("fishLog");e.innerHTML="";const t=[],n={};
            fishData.forEach(e=>{if(!n[e.species])n[e.species]=0;n[e.species]++;const a=n[e.species];"species_hunt"===currentScoringMethod?1===a?t.push({lbl:"1st: Starter (+30)",cls:"bg-success"}):2===a?t.push({lbl:"2nd: Builder (+30)",cls:"bg-info text-dark"}):3===a?t.push({lbl:"3rd: Full House (+40)",cls:"bg-warning text-dark"}):t.push({lbl:"Extra (+1)",cls:"bg-secondary"}):t.push({lbl:`${e.length} cm`,cls:"bg-transparent text-primary fs-5"})});
            [...fishData].reverse().forEach((n,a)=>{
                const o=fishData.length-1-a,s=t[o],c=document.createElement("tr");
                const photoHtml = n.photo ? `<img src="${n.photo}" class="fish-thumb ms-2" onclick="window.viewImage('${n.photo}')">` : '';
                const i="species_hunt"===currentScoringMethod?`<span class="badge ${s.cls}" style="font-size:0.75rem;">${s.lbl}</span>`:`<span class="fw-bold fs-5 text-primary">${n.length} cm</span>`;
                c.innerHTML=`<td class="align-middle"><div class="fw-bold text-dark">${n.species}</div><div class="d-flex align-items-center mt-1">${i}${photoHtml}</div></td><td class="text-end align-middle"><button class="btn btn-sm btn-outline-danger border-0" onclick="window.deleteFish(${o})"><i class="bi bi-trash"></i></button></td>`;
                e.appendChild(c)
            })
        };
        window.viewImage=function(src){document.getElementById('fullSizeImage').src=src; new bootstrap.Modal(document.getElementById('imageModal')).show()};
        window.deleteFish=function(e){confirm("Delete catch?")&&(fishData.splice(e,1),window.updateFishLog(),window.saveActiveSession())};
        
        window.endSession=function(){
            PageManager.show("tallyVerificationPage");
            document.getElementById("session_angler").textContent=currentAngler;
            document.getElementById("session_date").textContent=window.formatDate(currentDate);
            document.getElementById("session_venue").textContent=currentVenue;
            const e=document.getElementById("session_comp_details"),t=document.getElementById("session_verification_box");isCompetitionMode?(e.style.display="inline-block",document.getElementById("session_zone").textContent=currentZone,document.getElementById("session_peg").textContent=currentPeg,t.style.display="block"):(e.style.display="none",t.style.display="none");
            const n=document.getElementById("session_biggest_fish_card");"species_hunt"===currentScoringMethod?n.style.display="none":n.style.display="block";
            const a=window.calculatePoints(fishData,currentScoringMethod);document.getElementById("session_total_points").textContent=a;document.getElementById("session_total_fish").textContent=fishData.length;document.getElementById("session_species_count").textContent=new Set(fishData.map(e=>e.species)).size;document.getElementById("session_total_len").textContent=fishData.reduce((e,t)=>e+parseFloat(t.length||0),0).toFixed(1);
            let o=0,s="-";fishData.forEach(e=>{e.length>o&&(o=e.length,s=`${e.species} (${e.length}cm)`)}),document.getElementById("session_biggest_fish").textContent=s;
            const c=document.getElementById("session_breakdown_area");c.innerHTML="";
            if("species_hunt"===currentScoringMethod){const e={};fishData.forEach(t=>{e[t.species]||(e[t.species]=0),e[t.species]++});for(const t in e){const n=e[t];let a=0,o="";for(let e=1;e<=3;e++){let t=n>=e?"active":"",s=3===e?"gold":1===e?"bronze":"silver",c=1===e||2===e?30:40;n>=e&&(a+=c),o+=`<span class="pip ${s} ${t}">${c}</span>`}let s="";n>3&&(a+=n-3,s=`<span class="pip-extra">+${n-3} extra</span>`),c.innerHTML+=`<div class="species-quota-card"><div class="sq-header"><span class="sq-name">${t}</span><span class="sq-points">${a} pts</span></div><div class="sq-pips">${o}${s}</div></div>`}}else{let e='<table class="table-custom"><tbody>';fishData.forEach(t=>{const ph=t.photo?`<img src="${t.photo}" class="fish-thumb float-end ms-2" onclick="window.viewImage('${t.photo}')">`:'';e+=`<tr><td>${t.species}</td><td class="text-end fw-bold">${t.length} cm ${ph}</td></tr>`}),e+="</tbody></table>",c.innerHTML=e}
            window.saveActiveSession();
        };

        window.saveAndEndSession=function(){
            // FIXED: Prevent accidental form submission behavior
            const e=document.getElementById("witnessNameInput").value;
            const t=document.getElementById("witnessCheckbox").checked;
            const n=document.getElementById("sessionNotesInput").value;
            const a={angler:currentAngler,date:currentDate,venue:currentVenue,scoringMethod:currentScoringMethod,isComp:isCompetitionMode,zone:currentZone,peg:currentPeg,fishData:fishData,witness:e,verified:t,notes:n};
            StorageHelper.save(`scorecard_${Date.now()}`,JSON.stringify(a));
            StorageHelper.remove('active_session');
            window.resetApp();
        };

        window.loadSavedScorecards=function(){const e=document.getElementById("recentList");e.innerHTML="";const t=StorageHelper.getAll();Object.keys(t).sort().reverse().forEach(n=>{if(n.startsWith("scorecard_")){const a=JSON.parse(t[n]),o=window.calculatePoints(a.fishData,a.scoringMethod);e.innerHTML+=`<div class="inner-card p-3 mb-2"><div class="d-flex justify-content-between align-items-center"><div onclick="window.viewSaved('${n}')" style="flex-grow:1; cursor:pointer;"><div class="fw-bold text-dark">${a.venue}</div><div class="small text-muted">${window.formatDate(a.date)} <span class="badge bg-primary bg-opacity-10 text-primary ms-2">${o} pts</span></div></div><div class="card-actions"><button class="btn-card-icon delete" onclick="window.deleteScorecard('${n}')"><i class="bi bi-trash"></i></button><button class="btn-card-icon view" onclick="window.viewSaved('${n}')"><i class="bi bi-chevron-right"></i></button></div></div></div>`}})};
        window.deleteScorecard=function(e){confirm("Delete scorecard?")&&(StorageHelper.remove(e),window.loadSavedScorecards())};window.deleteCurrentSaved=function(){currentSavedKey&&confirm("Delete scorecard?")&&(StorageHelper.remove(currentSavedKey),window.backToScorecardList())};window.updateSavedNote=function(){if(currentSavedKey){const e=document.getElementById("saved_view_notes_input").value,t=JSON.parse(StorageHelper.get(currentSavedKey));t.notes=e,StorageHelper.save(currentSavedKey,JSON.stringify(t)),alert("Note updated!")}};
        
        window.viewSaved=function(e){const t=JSON.parse(StorageHelper.get(e));if(!t)return;currentSavedKey=e,document.getElementById("saved_view_angler").textContent=t.angler,document.getElementById("saved_view_date").textContent=window.formatDate(t.date),document.getElementById("saved_view_venue").textContent=t.venue,t.isComp?(document.getElementById("saved_view_comp_details").style.display="inline-block",document.getElementById("saved_view_zone").textContent=t.zone,document.getElementById("saved_view_peg").textContent=t.peg,document.getElementById("saved_view_comp_details").style.display="inline-block"):(document.getElementById("saved_view_comp_details").style.display="none");const n=window.calculatePoints(t.fishData,t.scoringMethod);document.getElementById("saved_view_points").textContent=n,document.getElementById("saved_view_total_fish").textContent=t.fishData.length,document.getElementById("saved_view_species_count").textContent=new Set(t.fishData.map(e=>e.species)).size,document.getElementById("saved_view_total_len").textContent=t.fishData.reduce((e,t)=>e+parseFloat(t.length||0),0).toFixed(1);const a=document.getElementById("saved_view_biggest_fish_card");if("species_hunt"===t.scoringMethod)a.style.display="none";else{a.style.display="block";let e=0,n="-";t.fishData.forEach(t=>{t.length>e&&(e=t.length,n=`${t.species} (${t.length}cm)`)}),document.getElementById("saved_view_biggest_fish").textContent=n}const o=document.getElementById("saved_view_verif");t.isComp&&t.verified?(o.style.display="block",o.textContent=`Verified by: ${t.witness}`):o.style.display="none",document.getElementById("saved_view_notes_input").value=t.notes||"";const s=document.getElementById("saved_view_breakdown");s.innerHTML="";if("species_hunt"===t.scoringMethod){const e={};t.fishData.forEach(t=>{e[t.species]||(e[t.species]=0),e[t.species]++});for(const t in e){const n=e[t];let a=0,o="";for(let e=1;e<=3;e++){let t=n>=e?"active":"",s=3===e?"gold":1===e?"bronze":"silver",c=1===e||2===e?30:40;n>=e&&(a+=c),o+=`<span class="pip ${s} ${t}">${c}</span>`}let s="";n>3&&(a+=n-3,s=`<span class="pip-extra">+${n-3} extra</span>`),c.innerHTML+=`<div class="species-quota-card"><div class="sq-header"><span class="sq-name">${t}</span><span class="sq-points">${a} pts</span></div><div class="sq-pips">${o}${s}</div></div>`}}else{let e='<table class="table-custom"><tbody>';t.fishData.forEach(t=>{const ph=t.photo?`<img src="${t.photo}" class="fish-thumb float-end ms-2" onclick="window.viewImage('${t.photo}')">`:'';e+=`<tr><td>${t.species}</td><td class="text-end fw-bold">${t.length} cm ${ph}</td></tr>`}),e+="</tbody></table>",s.innerHTML=e}document.getElementById("savedScorecardsList").style.display="none",document.getElementById("fullScorecardView").style.display="block"};
        
        window.backToScorecardList=function(){document.getElementById("fullScorecardView").style.display="none",document.getElementById("savedScorecardsList").style.display="block"};
        window.toggleCustomSpeciesInput=function(){const e=document.getElementById("speciesInput").value;document.getElementById("customSpeciesInput").style.display="Other"===e?"block":"none"};
        window.toggleCompetitionFields=function(){const e=document.getElementById("isCompetition").checked;document.getElementById("zoneInput").disabled=!e,document.getElementById("pegInput").disabled=!e};
        window.resetApp=function(){window.location.reload()};window.confirmQuit=function(){confirm("End session without saving?")&&(StorageHelper.remove('active_session'),window.resetApp())};
        window.shareAsImage=function(e){const t=document.getElementById("live"===e?"tallyVerificationPage":"fullScorecardView"),n=t.querySelectorAll("button, .btn");n.forEach(e=>e.style.display="none"),html2canvas(t,{backgroundColor:"#f0f4f8"}).then(e=>{n.forEach(e=>e.style.display=""),e.toBlob(e=>{const t=new File([e],"scorecard.png",{type:"image/png"});navigator.share?navigator.share({files:[t]}):((t=document.createElement("a")).download="score.png",t.href=e.toDataURL(),t.click())})})};
        document.addEventListener("DOMContentLoaded",()=>{window.restoreActiveSession();});
        let deferredPrompt;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e;const t=document.getElementById("btnInstall");t.style.display="block",t.addEventListener("click",()=>{t.style.display="none",deferredPrompt.prompt(),deferredPrompt=null})});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
